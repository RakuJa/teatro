app-id: io.github.rakuja.teatro
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: teatro
finish-args:
  # Audio access
  - --socket=pulseaudio
  # Display
  - --socket=fallback-x11
  - --socket=wayland
  # Network access for webview
  - --share=network
  # File system access for config files
  - --filesystem=xdg-config/teatro:create

modules:
  # Your application
  - name: teatro
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/teatro/cargo
    build-commands:
      - cargo --offline build --release

      - install -Dm755 target/release/teatro /app/bin/teatro-bin

      - mkdir -p /app/share/teatro/fonts
      - install -Dm644 ui/fonts/* /app/share/teatro/fonts/

      - mkdir -p /app/share/teatro/icons
      - install -Dm644 ui/icons/* /app/share/teatro/icons/

      - install -Dm644 ui/icons/teatro.png /app/share/icons/hicolor/256x256/apps/io.github.rakuja.teatro.png

      - install -Dm644 io.github.rakuja.teatro.desktop /app/share/applications/io.github.rakuja.teatro.desktop
      - install -Dm644 io.github.rakuja.teatro.metainfo.xml /app/share/metainfo/io.github.rakuja.teatro.metainfo.xml

      - |
        cat > /app/bin/teatro << 'EOF'
        #!/bin/sh
        export FONT_FOLDER="${FONT_FOLDER:-/app/share/teatro/fonts}"
        export ICON_FOLDER="${ICON_FOLDER:-/app/share/teatro/icons}"

        CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/teatro"
        mkdir -p "$CONFIG_DIR"

        if [ ! -f "$CONFIG_DIR/.env" ]; then
          echo "CONFIG_PATH=$CONFIG_DIR/config.toml" > "$CONFIG_DIR/.env"
          echo "CONFIG_PATH=$CONFIG_DIR/data.json" >> "$CONFIG_DIR/.env"
        fi

        cd "$CONFIG_DIR"
        exec /app/bin/teatro-bin
        EOF
      - chmod +x /app/bin/teatro

    sources:
      - type: dir
        path: . # code
      - generated-sources.json # deps